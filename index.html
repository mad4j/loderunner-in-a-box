<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>Lode Runner in a Box</title>

    <script type="text/javascript" src="js-dos-api-3.0.js"></script>
    <script type="text/javascript" src="js/zingtouch-1.0.6.min.js"></script>
    <style type="text/css">
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000; 
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }
        .dosbox-container { width: 640px; height: 400px; }
        .dosbox-container > .dosbox-overlay { background: url(cover.png); }
    </style>

  </head>
  <body>
    <div id="dosbox"></div>
    <br/>
    <!--
    <button onclick="dosbox.requestFullScreen();">Make fullscreen</button>
    -->
    
    <script type="text/javascript">
      var dosbox = new Dosbox({
        id: "dosbox",
        onload: function (dosbox) {
          dosbox.run("GAME.zip", "./LR.COM");
        },
        onrun: function (dosbox, app) {
          console.log("App '" + app + "' is runned");
        }
      });
    </script>

    <script type="text/javascript">
      //added fake auto-start
      window.onload = function() { 
        document
          .querySelector(".dosbox-start")
          .click();
      };
    </script>

    <script type="text/javascript">

      const tollerance = 90.0;
      const half_tollerance = 0.5*tollerance;

      var previous = 0.0;

      const keybEsc = {
        bubbles : true,
        cancelable : true,
        char : '\0',
        key : "Esc",
        code: "Esc",
        keyCode : 27
      };

      const keybNum2 = {
        bubbles : true,
        cancelable : true,
        char : '2',
        key : "2",
        code: "Numpad2",
        keyCode : 98
      };

      const keybNum4 = {
        bubbles : true,
        cancelable : true,
        char : '4',
        key : "4",
        code: "Numpad4",
        keyCode : 100
      };

      const keybNum5 = {
        bubbles : true,
        cancelable : true,
        char : '5',
        key : "5",
        code: "Numpad5",
        keyCode : 101
      };

      const keybNum6 = {
        bubbles : true,
        cancelable : true,
        char : '6',
        key : "6",
        code: "Numpad6",
        keyCode : 102
      }; 

      const keybNum7 = {
        bubbles : true,
        cancelable : true,
        char : '7',
        key : "7",
        code: "Numpad7",
        keyCode : 103
      }; 

      const keybNum8 = {
        bubbles : true,
        cancelable : true,
        char : '8',
        key : "8",
        code: "Numpad8",
        keyCode : 104
      }; 

      const keybNum9 = {
        bubbles : true,
        cancelable : true,
        char : '9',
        key : "9",
        code: "Numpad9",
        keyCode : 105
      };

      var containerElement = document.getElementById('dosbox');
      var activeRegion = ZingTouch.Region(containerElement);
      
      var tapTouch = new ZingTouch.Tap({ maxDelay: 3000 });

      activeRegion.bind(containerElement, tapTouch, function(e) {

        var t = e.detail.interval;
        var k = keybEsc;

        if (t > 1000) {
          k = keybEsc;
        } else {
          k = keybNum5;
        }

        document.dispatchEvent(new KeyboardEvent("keydown", k));
        document.dispatchEvent(new KeyboardEvent("keyup", k));
      });

      var panTouch = new ZingTouch.Pan();
      var panStart = panTouch.start;

      panTouch.start = function(inputs) {
        previous = -1.0;
        return panStart.call(this, inputs);
      }

      activeRegion.bind(containerElement, panTouch, function(e) { 

        var k = keybNum5;
        var d = Math.floor(e.detail.data[0].currentDirection);

        d = Math.floor((d+half_tollerance) / tollerance) * tollerance;

        if (d == 360.0) {
          d = 0.0;
        }

        if (d == previous) {
          return;
        }

        previous = d;

        switch (d) {

          case 0.0:
            k = keybNum6;
            break;
          case 90.0:
            k = keybNum8;
            break;
          case 180.0: 
            k = keybNum4;
            break;
          case 270.0: 
            k = keybNum2;
            break;
          default:
            k = keybNum5;
            break;
        }

        document.dispatchEvent(new KeyboardEvent("keydown", k));
        document.dispatchEvent(new KeyboardEvent("keyup", k));
      });

      var swipeTouch = new ZingTouch.Swipe({ numInputs:2, escapeVelocity: 0.25 });

      activeRegion.bind(containerElement, swipeTouch, function(e) { 

        var k = keybNum5;
        var d = Math.floor(e.detail.data[0].currentDirection) - 90.0;

        if (d > 180.0) {
          k = keybNum9;
        } else {
          k = keybNum7;
        }

        document.dispatchEvent(new KeyboardEvent("keydown", k));
        document.dispatchEvent(new KeyboardEvent("keyup", k));

        console.log(d);
      });


/*
      document.onkeydown = function(evt) {
        console.log(evt);
      };

      document.onkeyup = function(evt) {
        console.log(evt);
      };
*/
    </script>

  </body>
</html>
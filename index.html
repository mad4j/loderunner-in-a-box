<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lode Runner</title>

    <style>
        html,
        body {
            height: 100%;
        }

        #dos {
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- js-dos style sheet -->
    <link rel="stylesheet" href="./js-dos.css">

    <!-- js-dos -->
    <script src="./js-dos.js"></script>

</head>

<body>

    <div id="dos" style="width: 100%; height: 100%"></div>

    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const dosInstance = Dos(document.getElementById("dos"), {
            url: "./lr.jsdos",
            pathPrefix: "./emulators/",
            theme: "dark",
            kiosk: false,
            autoStart: true,
            noCursor: true,
            noCloud: true,
            noNetworking: true,
        });

        // Use PC scan codes for js-dos
        const keybEnter = { keyCode: 28 };
        const keybEsc = { keyCode: 1 };
        const keybNum2 = { keyCode: 80 };
        const keybNum4 = { keyCode: 75 };
        const keybNum5 = { keyCode: 76 };
        const keybNum6 = { keyCode: 77 };
        const keybNum7 = { keyCode: 71 };
        const keybNum8 = { keyCode: 72 };
        const keybNum9 = { keyCode: 73 };

        var el = document.getElementById("dos");
        dosInstance.ready.then(function (ci) {
            // --- Tap (touch/click) ---
            el.addEventListener("click", function (e) {
                var rect = el.getBoundingClientRect();
                var centerX = rect.left + rect.width / 2.0;
                var centerY = rect.top + rect.height / 2.0;
                var x = e.clientX - centerX;
                var y = e.clientY - centerY;
                var r = Math.min(rect.width, rect.height) / 2.0;
                var k = keybEnter;
                if (x * x + y * y < r * r) {
                    k = keybEnter;
                } else if (x < 0) {
                    k = keybNum7;
                } else {
                    k = keybNum9;
                }
                ci.sendKeyEvent(k.keyCode, true);
                setTimeout(function () { ci.sendKeyEvent(k.keyCode, false); }, 50);
            });

            // --- Touch tap ---
            el.addEventListener("touchend", function (e) {
                if (e.changedTouches.length > 0) {
                    var touch = e.changedTouches[0];
                    var rect = el.getBoundingClientRect();
                    var centerX = rect.left + rect.width / 2.0;
                    var centerY = rect.top + rect.height / 2.0;
                    var x = touch.clientX - centerX;
                    var y = touch.clientY - centerY;
                    var r = Math.min(rect.width, rect.height) / 2.0;
                    var k = keybEnter;
                    if (x * x + y * y < r * r) {
                        k = keybEnter;
                    } else if (x < 0) {
                        k = keybNum7;
                    } else {
                        k = keybNum9;
                    }
                    ci.sendKeyEvent(k.keyCode, true);
                    setTimeout(function () { ci.sendKeyEvent(k.keyCode, false); }, 50);
                }
            });

            // --- Pan (drag) ---
            var panStart = null;
            function handlePan(dx, dy) {
                var absDx = Math.abs(dx);
                var absDy = Math.abs(dy);
                var k = keybNum5;
                if (absDx > absDy) {
                    if (dx < 0) k = keybNum4;
                    else k = keybNum6;
                } else if (absDy > 0) {
                    if (dy < 0) k = keybNum8;
                    else k = keybNum2;
                }
                ci.sendKeyEvent(k.keyCode, true);
                setTimeout(function () { ci.sendKeyEvent(k.keyCode, false); }, 50);
            }
            // Mouse pan
            el.addEventListener("mousedown", function (e) {
                panStart = { x: e.clientX, y: e.clientY };
            });
            el.addEventListener("mouseup", function (e) {
                if (panStart) {
                    var dx = e.clientX - panStart.x;
                    var dy = e.clientY - panStart.y;
                    if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
                        handlePan(dx, dy);
                    }
                    panStart = null;
                }
            });
            // Touch pan
            el.addEventListener("touchstart", function (e) {
                if (e.touches.length === 1) {
                    var t = e.touches[0];
                    panStart = { x: t.clientX, y: t.clientY };
                }
            });
            el.addEventListener("touchend", function (e) {
                if (panStart && e.changedTouches.length > 0) {
                    var t = e.changedTouches[0];
                    var dx = t.clientX - panStart.x;
                    var dy = t.clientY - panStart.y;
                    if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
                        handlePan(dx, dy);
                    }
                    panStart = null;
                }
            });
        });
    });
    </script>
</body>

</html>
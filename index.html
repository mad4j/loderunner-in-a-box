<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>Lode Runner in a Box</title>

    <script type="text/javascript" src="js-dos-api-3.0.js"></script>
    <script type="text/javascript" src="js/hammer.min.js"></script>
    <style type="text/css">
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000; 
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }
        .dosbox-container { width: 640px; height: 400px; }
        .dosbox-container > .dosbox-overlay { background: url(cover.png); }
    </style>

  </head>
  <body>
    <div id="dosbox"></div>
    <br/>
    <!--
    <button onclick="dosbox.requestFullScreen();">Make fullscreen</button>
    -->
    
    <script type="text/javascript">
      var dosbox = new Dosbox({
        id: "dosbox",
        onload: function (dosbox) {
          dosbox.run("GAME.zip", "./LR.COM");
        },
        onrun: function (dosbox, app) {
          console.log("App '" + app + "' is runned");
        }
      });
    </script>

    <script type="text/javascript">
      //added fake auto-start
      window.onload = function() { 
        document
          .querySelector(".dosbox-start")
          .click();
      };
    </script>

    <script type="text/javascript">

      const keybEnter = {
        bubbles : true,
        cancelable : true,
        char : '\n',
        key : "Enter",
        code: "Enter",
        keyCode : 13
      };

      const keybEsc = {
        bubbles : true,
        cancelable : true,
        char : '\0',
        key : "Esc",
        code: "Esc",
        keyCode : 27
      };

      const keybNum2 = {
        bubbles : true,
        cancelable : true,
        char : '2',
        key : "2",
        code: "Numpad2",
        keyCode : 98
      };

      const keybNum4 = {
        bubbles : true,
        cancelable : true,
        char : '4',
        key : "4",
        code: "Numpad4",
        keyCode : 100
      };

      const keybNum5 = {
        bubbles : true,
        cancelable : true,
        char : '5',
        key : "5",
        code: "Numpad5",
        keyCode : 101
      };

      const keybNum6 = {
        bubbles : true,
        cancelable : true,
        char : '6',
        key : "6",
        code: "Numpad6",
        keyCode : 102
      };

      const keybNum7 = {
        bubbles : true,
        cancelable : true,
        char : '7',
        key : "7",
        code: "Numpad7",
        keyCode : 103
      };

      const keybNum8 = {
        bubbles : true,
        cancelable : true,
        char : '8',
        key : "8",
        code: "Numpad8",
        keyCode : 104
      };

      const keybNum9 = {
        bubbles : true,
        cancelable : true,
        char : '9',
        key : "9",
        code: "Numpad9",
        keyCode : 105
      };

	    var el = document.querySelector("#dosbox");
	    var mc = new Hammer.Manager(el);

      mc.add(new Hammer.Tap({ event: "doubletap", taps: 2 }));
      mc.add(new Hammer.Tap({ event: "singletap", taps: 1 }));

      mc.get("doubletap").recognizeWith("singletap");
      mc.get("singletap").requireFailure("doubletap");

      mc.on("singletap", function(e) {
        document.dispatchEvent(new KeyboardEvent("keydown", keybEnter));
        document.dispatchEvent(new KeyboardEvent("keyup", keybEnter));
      });

      mc.on("doubletap", function(e) {
        document.dispatchEvent(new KeyboardEvent("keydown", keybEsc));
        document.dispatchEvent(new KeyboardEvent("keyup", keybEsc));
      });

      mc.add(new Hammer.Pan({ event: "pan"}));
      mc.get("pan").set({ direction: Hammer.DIRECTION_ALL });

      var lastPan = "none";

      mc.on("panstart panend pancancel", function(e) {
        lastPan = "none";
      });

      mc.on("panleft", function(e) {

        if (e.type == lastPan) {
          return;
        }
        
        lastPan = e.type;
        
        var k = (firePressed) ? keybNum7 : keybNum4;
        document.dispatchEvent(new KeyboardEvent("keydown", k));
        document.dispatchEvent(new KeyboardEvent("keyup", k));
      });

      mc.on("panright", function(e) {

        if (e.type == lastPan) {
          return;
        }

        lastPan = e.type;

        var k = (firePressed) ? keybNum9 : keybNum6;
        document.dispatchEvent(new KeyboardEvent("keydown", k));
        document.dispatchEvent(new KeyboardEvent("keyup", k));
      });

      mc.on("panup", function(e) {

        if (e.type == lastPan) {
          return;
        }

        lastPan = e.type;

        document.dispatchEvent(new KeyboardEvent("keydown", keybNum8));
        document.dispatchEvent(new KeyboardEvent("keyup", keybNum8));
      });

      mc.on("pandown", function(e) {

        if (e.type == lastPan) {
          return;
        }

        lastPan = e.type;

        document.dispatchEvent(new KeyboardEvent("keydown", keybNum2));
        document.dispatchEvent(new KeyboardEvent("keyup", keybNum2));
      });

      mc.add(new Hammer.Press({ event: "press", threshold: 9 }));
      //mc.get("press").recognizeWith("press");

      var firePressed = false;
      mc.on("press pressup", function(e) {
        firePressed = e.type == "press";
        console.log(firePressed);
      });

/*
      document.onkeypress = function(evt) {
        console.log(evt);
      };

      document.onkeydown = function(evt) {
        console.log(evt);
      };

      document.onkeyup = function(evt) {
        console.log(evt);
      };
*/
    </script>

  </body>
</html>